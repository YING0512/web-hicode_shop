<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編輯商品 - Hey!Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components.js"></script>
</head>

<body class="bg-gray-50 text-gray-900">
    <div id="navbar-container"></div>

    <main class="min-h-screen pt-24 pb-12 px-4">
        <div class="max-w-2xl mx-auto bg-white border border-gray-200 p-8 rounded-lg shadow-sm">
            <h1 id="form-title" class="text-2xl font-bold mb-8 text-center text-gray-800">新增商品</h1>

            <form id="product-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">商品名稱</label>
                    <input type="text" name="name" required
                        class="w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition-colors">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">商品描述</label>
                    <textarea name="description" required
                        class="w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition-colors h-32"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">價格 ($)</label>
                        <input type="number" name="price" required min="0" step="0.01"
                            class="w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">庫存數量</label>
                        <input type="number" name="stock_quantity" required min="1"
                            class="w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">商品分類 ID</label>
                    <input type="number" name="category_id" required min="1" value="1"
                        class="w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition-colors">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">上架狀態</label>
                    <select name="status"
                        class="w-full bg-white border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition-colors cursor-pointer">
                        <option value="on_shelf">🟢 上架中 (On Shelf)</option>
                        <option value="off_shelf">🔴 已下架 (Off Shelf)</option>
                    </select>
                </div>

                <div id="image-upload-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">商品圖片 (編輯模式暫不支援修改圖片)</label>
                    <div class="flex items-center space-x-4">
                        <input type="file" name="image" accept="image/*" onchange="previewImage(this)">
                    </div>
                    <div id="preview-container" class="mt-4 hidden">
                        <p class="text-sm text-gray-500 mb-2">預覽:</p>
                        <img id="preview-img" src="" alt="Preview"
                            class="h-48 w-full object-cover rounded border border-gray-200">
                    </div>
                </div>

                <button type="submit" id="submit-btn"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">確認上架</button>
            </form>
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const isEditing = !!productId;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.checkAuth()) return;
            renderNavbar();

            if (isEditing) {
                document.getElementById('form-title').textContent = '編輯商品';
                document.getElementById('submit-btn').textContent = '更新商品';
                document.getElementById('image-upload-section').innerHTML = '<p class="text-sm text-gray-500">編輯模式下暫無法更換圖片</p>'; // Following existing logic

                await loadProductData(productId);
            }
        });

        async function loadProductData(id) {
            const user = Auth.getUser();
            // We can fetch from product details API or find from products list
            // Since we don't have a single product endpoint easily documented, let's fetch list and find
            try {
                const products = await fetchApi(`/products.php?seller_id=${user.user_id}`);
                const product = products.find(p => p.product_id == id);
                if (product) {
                    const form = document.getElementById('product-form');
                    form.name.value = product.name;
                    form.description.value = product.description;
                    form.price.value = product.price;
                    form.stock_quantity.value = product.stock_quantity;
                    form.category_id.value = product.category_id || 1;
                    form.status.value = product.status || 'on_shelf';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-container').classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.textContent = '處理中...';

            const user = Auth.getUser();
            const form = e.target;

            try {
                if (isEditing) {
                    // Update (PUT JSON)
                    const payload = {
                        product_id: productId,
                        seller_id: user.user_id,
                        name: form.name.value,
                        description: form.description.value,
                        price: form.price.value,
                        stock_quantity: form.stock_quantity.value,
                        category_id: form.category_id.value,
                        status: form.status.value
                    };

                    await fetchApi('/products.php', {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                    alert('商品更新成功！');

                } else {
                    // Create (POST FormData)
                    const formData = new FormData(form);
                    formData.append('seller_id', user.user_id);

                    // fetchApi assumes JSON by default if body is object, need to handle FormData
                    // We'll use raw fetch because fetchApi sets Content-Type: application/json which breaks FormData boundary
                    const token = localStorage.getItem('token');
                    const res = await fetch('/1208/backend/products.php', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Failed');
                    alert('商品上架成功！');
                }
                window.location.href = 'seller-dashboard.html';

            } catch (err) {
                alert('操作失敗: ' + err.message);
                btn.disabled = false;
                btn.textContent = isEditing ? '更新商品' : '確認上架';
            }
        });
    </script>
</body>

</html>
